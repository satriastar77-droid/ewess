<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EWESS Dashboard</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>


    <style>
        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
        }
    </style>
</head>

<body class="p-6">
    <h1 class="text-3xl font-bold mb-6">EWESS – Monitoring Dashboard</h1>

    <!-- GRID LAYOUT -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- REALTIME STATUS CARD -->
        <div id="realtimeCard" class="card col-span-1">
            <h2 class="text-xl font-semibold mb-4">Realtime Status</h2>

            <p class="mb-2">Event:
                <span id="eventStatus" class="font-bold text-green-400">IDLE</span>
            </p>

            <p class="mb-2">Shake Status:
                <span id="shakeStatus" class="font-bold text-blue-300">-</span>
            </p>

            <p class="mb-2">Intensity:
                <span id="intensity" class="font-bold text-green-300">0</span>
            </p>
        </div>

        <!-- SENSOR REALTIME CHART -->
        <div class="card col-span-1 md:col-span-3">
            <h2 class="text-xl font-semibold mb-4">Realtime Intensity</h2>
            <canvas id="sensorChart"></canvas>
        </div>


        <div class="card col-span-1 md:col-span-3 mt-6">
            <h2 class="text-xl font-semibold mb-4">
                Intensity History per Event
            </h2>
            <canvas id="eventHistoryChart"></canvas>
        </div>
    </div>


    <!-- LOG TABLE (EVENT-BASED) -->
    <div class="card mt-8">
        <h2 class="text-xl font-semibold mb-4">Event Log History (Latest)</h2>

        <div class="overflow-y-auto max-h-96">
            <table class="min-w-full text-left text-sm">
                <thead>
                    <tr class="border-b border-gray-600 text-gray-300">
                        <th class="py-2">Start</th>
                        <th>End</th>
                        <th>Duration (s)</th>
                        <th>Max Intensity</th>
                        <th>Avg Intensity</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="logTable"></tbody>
            </table>
        </div>
    </div>


    <!-- JAVASCRIPT -->
    <script>
        /* ===============================
           CONFIG
        ================================ */
        const realtimeURL = "/api/realtime";
        const logsURL = "/api/logs";
        const statsURL = "/api/stats";

        let viewingEvent = false;

        /* ===============================
           UTIL
        ================================ */
        function formatTime(ts) {
            if (!ts) return "-";

            // parsing sebagai local time
            const [date, time] = ts.split("T");
            const [y, m, d] = date.split("-").map(Number);
            const [hh, mm, ss] = time.split(":").map(Number);

            const localDate = new Date(y, m - 1, d, hh, mm, ss);

            return localDate.toLocaleTimeString("id-ID", {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit"
            }) + " • " + localDate.toLocaleDateString("id-ID");
        }
        function parseLocalDate(ts) {
            if (!ts || typeof ts !== "string") return null;

            // buang timezone & microseconds (AMAN untuk Chart.js)
            const clean = ts.replace("Z", "").split(".")[0];

            const [date, time] = clean.split("T");
            if (!date || !time) return null;

            const [y, m, d] = date.split("-").map(Number);
            const [hh, mm, ss] = time.split(":").map(Number);

            const result = new Date(y, m - 1, d, hh, mm, ss);
            return isNaN(result.getTime()) ? null : result;
        }




        /* ===============================
           CHART: REALTIME SENSOR
        ================================ */
        const sensorChart = new Chart(
            document.getElementById("sensorChart").getContext("2d"),
            {
                type: "line",
                data: {
                    datasets: [{
                        label: "Realtime Intensity",
                        data: [],
                        borderWidth: 2,
                        tension: 0.3
                    }]
                },
                options: {
                    animation: false,
                    scales: {
                        x: { type: "time", time: { unit: "second" } },
                        y: { beginAtZero: true }
                    }
                }
            }
        );

        /* ===============================
           CHART: EVENT HISTORY
        ================================ */
        const eventHistoryChart = new Chart(
            document.getElementById("eventHistoryChart").getContext("2d"),
            {
                type: "line",
                data: {
                    datasets: [{
                        label: "Event Intensity",
                        data: [],
                        borderWidth: 2,
                        tension: 0.3
                    }]
                },
                options: {
                    scales: {
                        x: { type: "time", time: { unit: "second" } },
                        y: { beginAtZero: true }
                    }
                }
            }
        );

        /* ===============================
           FETCH REALTIME
        ================================ */
        async function fetchRealtime() {
            console.log("FETCH REALTIME CALLED");
            try {
                const res = await fetch(realtimeURL);
                if (!res.ok) return;

                const data = await res.json();

                // ===== TEXT STATUS =====
                document.getElementById("eventStatus").textContent =
                    data.event_active ? "ACTIVE" : "IDLE";

                document.getElementById("shakeStatus").textContent =
                    data.shake ? "YES" : "NO";

                document.getElementById("intensity").textContent =
                    data.intensity ?? 0;

                const eventStatus = document.getElementById("eventStatus");
                const card = document.getElementById("realtimeCard");

                if (data.event_active) {
                    eventStatus.textContent = "ACTIVE";
                    eventStatus.className = "font-bold text-red-400";
                    card.classList.add("ring", "ring-red-500");
                } else {
                    eventStatus.textContent = "IDLE";
                    eventStatus.className = "font-bold text-green-400";
                    card.classList.remove("ring", "ring-red-500");
                }

                // ===== CHART DATA =====
                const xDate = parseLocalDate(data.timestamp);
                console.log("PARSED DATE:", xDate, "INT:", data.intensity);

                if (xDate) {
                    sensorChart.data.datasets[0].data.push({
                        x: xDate,
                        y: Number(data.intensity) || 0
                    });

                    // limit data (sliding window)
                    if (sensorChart.data.datasets[0].data.length > 10) {
                        sensorChart.data.datasets[0].data.shift();
                    }

                    sensorChart.update("none"); // no animation (realtime)
                }

            } catch (err) {
                console.error("fetchRealtime error:", err);
            }
        }


        /* ===============================
           FETCH LOGS (TABLE)
           USE event_id (FK-safe)
        ================================ */
        async function fetchLogs() {
            if (viewingEvent) return;

            const res = await fetch(logsURL);
            if (!res.ok) return;

            const logs = await res.json();
            const table = document.getElementById("logTable");
            table.innerHTML = "";

            logs.forEach(row => {
                if (!row.event_id) return;

                const tr = document.createElement("tr");
                tr.className = "border-b border-gray-700";

                tr.innerHTML = `
            <td class="py-2">${formatTime(row.start_time)}</td>
            <td>${formatTime(row.end_time)}</td>
            <td>${row.duration_sec}</td>
            <td>${row.max_intensity}</td>
            <td>${row.avg_intensity}</td>
            <td>
                <button class="px-3 py-1 bg-blue-600 rounded text-sm hover:bg-blue-700">
                    View
                </button>
            </td>
            <td>
                
                <button class="delete-btn text-red-400 ml-2">Delete</button>
             </td>
        `;

                tr.querySelector("button").onclick = () => {
                    loadEventTimeline(row.event_id);
                };
                tr.querySelector(".delete-btn").onclick = async () => {
                    if (!confirm("Hapus event ini beserta seluruh datanya?")) return;

                    const res = await fetch(`/api/event/${row.event_id}`, {
                        method: "DELETE"
                    });

                    if (res.ok) {
                        fetchLogs(); // refresh tabel
                        eventHistoryChart.data.datasets[0].data = [];
                        eventHistoryChart.update();
                        viewingEvent = false;
                    }
                };

                table.appendChild(tr);
            });
        }

        /* ===============================
           FETCH EVENT TIMELINE
           FK: quake_event_samples.event_id
        ================================ */
        async function loadEventTimeline(eventId) {
            if (!eventId) return;

            viewingEvent = true;

            const res = await fetch(`/api/event/${eventId}/timeline`);
            if (!res.ok) return;

            const json = await res.json();

            eventHistoryChart.data.datasets[0].data =
                json.samples.map(s => ({
                    x: parseLocalDate(s.recorded_at),
                    y: s.intensity
                }));

            eventHistoryChart.data.datasets[0].label =
                `Event #${eventId} Intensity`;

            eventHistoryChart.update();
        }

        /* ===============================
           INTERVALS
        ================================ */
        setInterval(fetchRealtime, 1000);
        setInterval(fetchLogs, 3000);
        setInterval(fetchStats, 5000);

        /* ===============================
           INITIAL LOAD
        ================================ */
        fetchRealtime();
        fetchLogs();
        fetchStats();

    </script>


</body>

</html>