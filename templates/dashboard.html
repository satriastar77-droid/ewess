<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EWESS Dashboard</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
            color: #e2e8f0;
            font-family: 'Space Grotesk', sans-serif;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gridMove {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(40px, 40px);
            }
        }

        .container {
            position: relative;
            z-index: 1;
        }

        .card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95));
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(99, 102, 241, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.15);
        }

        .header-glow {
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .status-idle {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-active {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .metric-card {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(99, 102, 241, 0.15);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(15, 23, 42, 0.7);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        thead th {
            background: rgba(99, 102, 241, 0.1);
            padding: 12px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #a78bfa;
            border: none;
        }

        tbody tr {
            background: rgba(15, 23, 42, 0.5);
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: rgba(30, 41, 59, 0.8);
            transform: scale(1.01);
        }

        tbody td {
            padding: 14px 12px;
            border-top: 1px solid rgba(99, 102, 241, 0.1);
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        }

        tbody td:first-child {
            border-left: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 8px 0 0 8px;
        }

        tbody td:last-child {
            border-right: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 0 8px 8px 0;
        }

        .intensity-bar {
            height: 6px;
            background: linear-gradient(90deg, #10b981, #fbbf24, #ef4444);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading-shimmer {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, rgba(99, 102, 241, 0.2) 50%, rgba(99, 102, 241, 0.1) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .scrollbar-custom {
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.5) rgba(30, 41, 59, 0.5);
        }

        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar-custom::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.7);
        }

        @media (max-width: 768px) {
            .card {
                padding: 16px;
            }

            .metric-value {
                font-size: 1.5rem;
            }

            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>

<body>
    <div class="container p-6 md:p-8 max-w-7xl mx-auto">
        <!-- HEADER -->
        <div class="mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-2 header-glow">EWESS Monitoring</h1>
            <p class="text-gray-400 text-sm">Early Warning Earthquake Sensing System</p>
        </div>

        <!-- GRID LAYOUT -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- REALTIME STATUS CARD -->
            <div id="realtimeCard" class="card lg:col-span-4 transition-all duration-300">
                <h2 class="section-title">Realtime Status</h2>

                <div class="space-y-4">
                    <!-- Event Status -->
                    <div class="metric-card">
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-2">Event Status</p>
                        <div id="eventStatusBadge" class="status-badge status-idle">
                            <span class="status-indicator bg-green-400"></span>
                            <span id="eventStatus">IDLE</span>
                        </div>
                    </div>

                    <!-- Shake Detection -->
                    <div class="metric-card">
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-2">Shake Detection</p>
                        <p id="shakeStatus" class="text-2xl font-bold text-blue-300">-</p>
                    </div>

                    <!-- Current Intensity -->
                    <div class="metric-card">
                        <p class="text-gray-400 text-xs uppercase tracking-wider mb-2">Current Intensity</p>
                        <p id="intensity" class="metric-value">0</p>
                        <div class="mt-2 bg-gray-700 rounded-full h-2 overflow-hidden">
                            <div id="intensityBar" class="intensity-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SENSOR REALTIME CHART -->
            <div class="card lg:col-span-8">
                <h2 class="section-title">Realtime Intensity Stream</h2>
                <div class="chart-container">
                    <canvas id="sensorChart"></canvas>
                </div>
            </div>

            <!-- EVENT HISTORY CHART -->
            <div class="card lg:col-span-12">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="section-title mb-0">Event Intensity Timeline</h2>
                    <button id="clearEventBtn" class="btn-primary text-xs" style="display: none;">
                        Clear View
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="eventHistoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- LOG TABLE (EVENT-BASED) -->
        <div class="card mt-8">
            <h2 class="section-title">Event History Log</h2>

            <div class="overflow-y-auto max-h-96 scrollbar-custom">
                <table>
                    <thead>
                        <tr>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                            <th>Max Intensity</th>
                            <th>Avg Intensity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="logTable">
                        <tr>
                            <td colspan="6" class="text-center py-8">
                                <div class="loading-shimmer h-8 rounded"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        /* ===============================
           CONFIG
        ================================ */
        const realtimeURL = "/api/realtime";
        const logsURL = "/api/logs";
        const statsURL = "/api/stats";

        let viewingEvent = false;

        /* ===============================
           UTIL
        ================================ */
        function formatTime(ts) {
            if (!ts) return "-";

            // parsing sebagai local time
            const [date, time] = ts.split("T");
            const [y, m, d] = date.split("-").map(Number);
            const [hh, mm, ss] = time.split(":").map(Number);

            const localDate = new Date(y, m - 1, d, hh, mm, ss);

            return localDate.toLocaleTimeString("id-ID", {
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit"
            }) + " â€¢ " + localDate.toLocaleDateString("id-ID");
        }

        function parseLocalDate(ts) {
            if (!ts || typeof ts !== "string") return null;

            // buang timezone & microseconds (AMAN untuk Chart.js)
            const clean = ts.replace("Z", "").split(".")[0];

            const [date, time] = clean.split("T");
            if (!date || !time) return null;

            const [y, m, d] = date.split("-").map(Number);
            const [hh, mm, ss] = time.split(":").map(Number);

            const result = new Date(y, m - 1, d, hh, mm, ss);
            return isNaN(result.getTime()) ? null : result;
        }

        /* ===============================
           CHART: REALTIME SENSOR
        ================================ */
        const sensorChart = new Chart(
            document.getElementById("sensorChart").getContext("2d"),
            {
                type: "line",
                data: {
                    datasets: [{
                        label: "Intensity",
                        data: [],
                        borderColor: "rgba(99, 102, 241, 1)",
                        backgroundColor: "rgba(99, 102, 241, 0.1)",
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: "rgba(99, 102, 241, 1)",
                        pointBorderColor: "rgba(255, 255, 255, 0.8)",
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: "rgba(15, 23, 42, 0.95)",
                            titleColor: "#a78bfa",
                            bodyColor: "#e2e8f0",
                            borderColor: "rgba(99, 102, 241, 0.5)",
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            type: "time",
                            time: { unit: "second" },
                            grid: {
                                color: "rgba(99, 102, 241, 0.1)",
                                drawBorder: false
                            },
                            ticks: {
                                color: "#94a3b8"
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: "rgba(99, 102, 241, 0.1)",
                                drawBorder: false
                            },
                            ticks: {
                                color: "#94a3b8"
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            }
        );

        /* ===============================
           CHART: EVENT HISTORY
        ================================ */
        const eventHistoryChart = new Chart(
            document.getElementById("eventHistoryChart").getContext("2d"),
            {
                type: "line",
                data: {
                    datasets: [{
                        label: "Event Intensity",
                        data: [],
                        borderColor: "rgba(167, 139, 250, 1)",
                        backgroundColor: "rgba(167, 139, 250, 0.1)",
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: "rgba(167, 139, 250, 1)",
                        pointBorderColor: "rgba(255, 255, 255, 0.8)",
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: "#a78bfa",
                                font: {
                                    size: 12,
                                    weight: 600
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: "rgba(15, 23, 42, 0.95)",
                            titleColor: "#a78bfa",
                            bodyColor: "#e2e8f0",
                            borderColor: "rgba(167, 139, 250, 0.5)",
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        x: {
                            type: "time",
                            time: { unit: "second" },
                            grid: {
                                color: "rgba(99, 102, 241, 0.1)",
                                drawBorder: false
                            },
                            ticks: {
                                color: "#94a3b8"
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: "rgba(99, 102, 241, 0.1)",
                                drawBorder: false
                            },
                            ticks: {
                                color: "#94a3b8"
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            }
        );

        /* ===============================
           FETCH REALTIME
        ================================ */
        async function fetchRealtime() {
            try {
                const res = await fetch(realtimeURL);
                if (!res.ok) return;

                const data = await res.json();

                // ===== TEXT STATUS =====
                const eventStatusBadge = document.getElementById("eventStatusBadge");
                const eventStatus = document.getElementById("eventStatus");
                const card = document.getElementById("realtimeCard");
                const statusIndicator = eventStatusBadge.querySelector(".status-indicator");

                if (data.event_active) {
                    eventStatus.textContent = "ACTIVE";
                    eventStatusBadge.className = "status-badge status-active";
                    statusIndicator.className = "status-indicator bg-red-400";
                    card.style.borderColor = "rgba(239, 68, 68, 0.5)";
                } else {
                    eventStatus.textContent = "IDLE";
                    eventStatusBadge.className = "status-badge status-idle";
                    statusIndicator.className = "status-indicator bg-green-400";
                    card.style.borderColor = "rgba(99, 102, 241, 0.1)";
                }

                document.getElementById("shakeStatus").textContent = data.shake ? "YES" : "NO";
                document.getElementById("intensity").textContent = data.intensity ?? 0;

                // Update intensity bar
                const intensityBar = document.getElementById("intensityBar");
                const intensityPercent = Math.min((data.intensity / 100) * 100, 100);
                intensityBar.style.width = intensityPercent + "%";

                // ===== CHART DATA =====
                const xDate = parseLocalDate(data.timestamp);

                if (xDate) {
                    sensorChart.data.datasets[0].data.push({
                        x: xDate,
                        y: Number(data.intensity) || 0
                    });

                    // limit data (sliding window)
                    if (sensorChart.data.datasets[0].data.length > 10) {
                        sensorChart.data.datasets[0].data.shift();
                    }

                    sensorChart.update("none"); // no animation (realtime)
                }

            } catch (err) {
                console.error("fetchRealtime error:", err);
            }
        }

        /* ===============================
           FETCH LOGS (TABLE)
        ================================ */
        async function fetchLogs() {
            if (viewingEvent) return;

            const res = await fetch(logsURL);
            if (!res.ok) return;

            const logs = await res.json();
            const table = document.getElementById("logTable");
            table.innerHTML = "";

            if (logs.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            No events recorded yet
                        </td>
                    </tr>
                `;
                return;
            }

            logs.forEach(row => {
                if (!row.event_id) return;

                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td class="font-mono text-sm">${formatTime(row.start_time)}</td>
                    <td class="font-mono text-sm">${formatTime(row.end_time)}</td>
                    <td class="font-semibold">${row.duration_sec}s</td>
                    <td class="font-bold text-red-400">${row.max_intensity}</td>
                    <td class="font-semibold text-blue-400">${row.avg_intensity}</td>
                    <td>
                        <div class="flex gap-2">
                            <button class="view-btn btn-primary">View</button>
                            <button class="delete-btn btn-danger">Delete</button>
                        </div>
                    </td>
                `;

                tr.querySelector(".view-btn").onclick = () => {
                    loadEventTimeline(row.event_id);
                };

                tr.querySelector(".delete-btn").onclick = async () => {
                    if (!confirm("Hapus event ini beserta seluruh datanya?")) return;

                    const res = await fetch(`/api/event/${row.event_id}`, {
                        method: "DELETE"
                    });

                    if (res.ok) {
                        fetchLogs();
                        eventHistoryChart.data.datasets[0].data = [];
                        eventHistoryChart.update();
                        viewingEvent = false;
                        document.getElementById("clearEventBtn").style.display = "none";
                    }
                };

                table.appendChild(tr);
            });
        }

        /* ===============================
           FETCH EVENT TIMELINE
        ================================ */
        async function loadEventTimeline(eventId) {
            if (!eventId) return;

            viewingEvent = true;
            document.getElementById("clearEventBtn").style.display = "block";

            const res = await fetch(`/api/event/${eventId}/timeline`);
            if (!res.ok) return;

            const json = await res.json();

            eventHistoryChart.data.datasets[0].data =
                json.samples.map(s => ({
                    x: parseLocalDate(s.recorded_at),
                    y: s.intensity
                }));

            eventHistoryChart.data.datasets[0].label = `Event #${eventId} Intensity`;
            eventHistoryChart.update();
        }

        /* ===============================
           CLEAR EVENT VIEW
        ================================ */
        document.getElementById("clearEventBtn").onclick = () => {
            viewingEvent = false;
            eventHistoryChart.data.datasets[0].data = [];
            eventHistoryChart.data.datasets[0].label = "Event Intensity";
            eventHistoryChart.update();
            document.getElementById("clearEventBtn").style.display = "none";
        };

        /* ===============================
           FETCH STATS (PLACEHOLDER)
        ================================ */
        async function fetchStats() {
            // Implementasi sesuai kebutuhan
        }

        /* ===============================
           INTERVALS
        ================================ */
        setInterval(fetchRealtime, 1000);
        setInterval(fetchLogs, 3000);
        setInterval(fetchStats, 5000);

        /* ===============================
           INITIAL LOAD
        ================================ */
        fetchRealtime();
        fetchLogs();
        fetchStats();

    </script>
</body>

</html>
